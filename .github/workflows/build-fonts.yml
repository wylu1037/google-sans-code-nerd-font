name: Build Google Sans Code Nerd Fonts

on:
  push:
    branches: [ main ]
    paths:
      - 'data/google-sans-code/**'
      - '.github/workflows/build-fonts.yml'
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
    paths:
      - 'data/google-sans-code/**'
      - '.github/workflows/build-fonts.yml'
  workflow_dispatch:

jobs:
  build-fonts:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        # Install FontForge for ligaturizer
        sudo apt-get update
        sudo apt-get install -y fontforge python3-fontforge
        
        # GitHub Actions environment already has Docker pre-installed
        # Pull the official Nerd Font patcher Docker image
        docker pull nerdfonts/patcher:latest
        
        # Verify setup
        docker --version
        docker images | grep nerdfonts
        fontforge --version
        
    - name: Create output directory
      run: |
        mkdir -p output/ligaturized-fonts
        mkdir -p output/patched-fonts
        
    - name: Setup Ligaturizer
      run: |
        # Download Ligaturizer dependency files
        curl -L https://raw.githubusercontent.com/ToxicFrog/ligaturizer/master/ligatures.py -o ligatures.py
        curl -L https://raw.githubusercontent.com/ToxicFrog/ligaturizer/master/char_dict.py -o char_dict.py
        
        # Use our fixed version of ligaturize.py to avoid TypeError
        cp scripts/ligaturize-fixed.py ligaturize.py
        chmod +x ligaturize.py
        
        # Download Fira Code for ligature source
        mkdir -p fonts/fira/distr/otf
        echo "Downloading FiraCode..."
        curl -L https://github.com/tonsky/FiraCode/releases/download/6.2/Fira_Code_v6.2.zip -o FiraCode.zip
        
        # Verify download and extract
        echo "Verifying downloaded file..."
        file FiraCode.zip
        ls -la FiraCode.zip
        
        echo "Extracting FiraCode..."
        unzip -q FiraCode.zip -d temp/
        
        # FiraCode 6.2 only has TTF files, but Ligaturizer expects OTF
        # We'll copy TTF files to the OTF directory with .otf extension
        echo "Setting up FiraCode files for Ligaturizer..."
        ls -la temp/ttf/
        
        # Copy TTF files and rename them to .otf for Ligaturizer compatibility
        for ttf_file in temp/ttf/*.ttf; do
          if [ -f "$ttf_file" ]; then
            filename=$(basename "$ttf_file" .ttf)
            echo "Copying $filename.ttf as $filename.otf"
            cp "$ttf_file" "fonts/fira/distr/otf/$filename.otf"
          fi
        done
        
        rm -rf temp FiraCode.zip
        
        echo "Ligaturizer setup complete"
        ls -la fonts/fira/distr/otf/
        
    - name: Add ligatures to fonts
      run: |
        echo "Adding ligatures to Google Sans Code fonts..."
        
        INPUT_DIR=$(realpath data/google-sans-code/static)
        LIGATURIZED_DIR=$(realpath output/ligaturized-fonts)
        
        echo "Input directory: $INPUT_DIR"
        echo "Ligaturized output directory: $LIGATURIZED_DIR"
        
        # Verify all dependencies before processing
        echo "Verifying dependencies..."
        echo "Ligaturizer scripts:"
        ls -la ligaturize.py ligatures.py char_dict.py
        echo "FiraCode source files:"
        ls -la fonts/fira/distr/otf/
        echo "Input fonts to process:"
        ls -la "$INPUT_DIR"/*.ttf
        
        # Function to add ligatures to a single font
        ligaturize_font() {
          local font_file="$1"
          local font_name=$(basename "$font_file")
          echo "=== Processing: $font_name ==="
          
          # Extract style from filename for consistent naming
          local style=$(echo "$font_name" | sed 's/GoogleSansCode-//g' | sed 's/\.ttf$//g')
          echo "Detected style: $style"
          
          # Add ligatures using fontforge with detailed output
          echo "Running Ligaturizer..."
          if fontforge -lang=py -script ligaturize.py "$font_file" \
            --output-dir="$LIGATURIZED_DIR" \
            --prefix="GoogleSansCodeLig"; then
            echo "✅ Successfully ligaturized: $font_name"
          else
            echo "❌ Failed to ligaturize: $font_name"
            return 1
          fi
        }
        
        # Export function for parallel execution  
        export -f ligaturize_font
        export LIGATURIZED_DIR
        
        # Process fonts sequentially first to debug any issues
        echo "Processing fonts sequentially for debugging..."
        success_count=0
        total_count=0
        
        for font_file in "$INPUT_DIR"/*.ttf; do
          if [ -f "$font_file" ]; then
            total_count=$((total_count + 1))
            if ligaturize_font "$font_file"; then
              success_count=$((success_count + 1))
            fi
          fi
        done
        
        echo "=== Ligaturization Summary ==="
        echo "Processed: $success_count/$total_count fonts"
        
        # Show ligaturized results
        echo "Ligaturized font files:"
        if [ -d "$LIGATURIZED_DIR" ]; then
          ls -la "$LIGATURIZED_DIR"/
          ligaturized_count=$(find "$LIGATURIZED_DIR" -name "*.ttf" | wc -l)
          echo "Generated $ligaturized_count ligaturized font files"
          
          if [ $ligaturized_count -eq 0 ]; then
            echo "❌ ERROR: No ligaturized fonts were generated!"
            echo "This will cause the next step to fail."
            exit 1
          fi
        else
          echo "❌ ERROR: Ligaturized output directory does not exist!"
          exit 1
        fi
        
    - name: Patch fonts using Docker
      run: |
        echo "Starting Nerd Font patching with Docker..."
        
        # Set up directories
        LIGATURIZED_DIR=$(realpath output/ligaturized-fonts)
        ORIGINAL_DIR=$(realpath data/google-sans-code/static)
        OUTPUT_DIR=$(realpath output/patched-fonts)
        
        echo "Ligaturized input directory: $LIGATURIZED_DIR"
        echo "Original input directory: $ORIGINAL_DIR"
        echo "Final output directory: $OUTPUT_DIR"
        
        # Check which fonts to process
        echo "=== Checking font availability ==="
        ligaturized_count=0
        original_count=0
        
        if [ -d "$LIGATURIZED_DIR" ]; then
          ligaturized_count=$(find "$LIGATURIZED_DIR" -name "*.ttf" 2>/dev/null | wc -l)
        fi
        
        if [ -d "$ORIGINAL_DIR" ]; then
          original_count=$(find "$ORIGINAL_DIR" -name "*.ttf" 2>/dev/null | wc -l)
        fi
        
        echo "Ligaturized fonts available: $ligaturized_count"
        echo "Original fonts available: $original_count"
        
        # Determine input source
        if [ $ligaturized_count -gt 0 ]; then
          FONT_INPUT_DIR="$LIGATURIZED_DIR"
          echo "✅ Using ligaturized fonts as input"
          echo "Ligaturized fonts to process:"
          ls -la "$LIGATURIZED_DIR"/*.ttf
        elif [ $original_count -gt 0 ]; then
          FONT_INPUT_DIR="$ORIGINAL_DIR"
          echo "⚠️  Ligaturized fonts not available, using original fonts"
          echo "Original fonts to process:"
          ls -la "$ORIGINAL_DIR"/*.ttf
        else
          echo "❌ ERROR: No fonts available for processing!"
          exit 1
        fi
        
        # Function to process a single font file
        process_font() {
          local font_file="$1"
          local font_name=$(basename "$font_file")
          echo "=== Processing: $font_name ==="
          
          # Create temporary directory for single font processing
          local temp_input_dir=$(mktemp -d)
          cp "$font_file" "$temp_input_dir/"
          
          # Process with Nerd Font Patcher, maintaining ligature functionality
          echo "Running Nerd Font Patcher..."
          if docker run --rm \
            -v "$temp_input_dir":/in \
            -v "$OUTPUT_DIR":/out \
            nerdfonts/patcher:latest \
            --complete \
            --quiet \
            --name "Google\ Sans\ Code\ NF"; then
            echo "✅ Successfully patched: $font_name"
          else
            echo "❌ Failed to patch: $font_name"
            # Clean up and continue with other fonts
            rm -rf "$temp_input_dir"
            return 1
          fi
          
          # Clean up temporary directory
          rm -rf "$temp_input_dir"
        }
        
        # Export function for parallel execution
        export -f process_font
        export OUTPUT_DIR
        
        # Process fonts sequentially for better error handling
        echo "=== Processing fonts ==="
        success_count=0
        total_count=0
        
        for font_file in "$FONT_INPUT_DIR"/*.ttf; do
          if [ -f "$font_file" ]; then
            total_count=$((total_count + 1))
            if process_font "$font_file"; then
              success_count=$((success_count + 1))
            fi
          fi
        done
        
        echo "=== Processing Summary ==="
        echo "Successfully processed: $success_count/$total_count fonts"

        # Show processing results
        echo "Final processed font files:"
        if [ -d "$OUTPUT_DIR" ]; then
          ls -la "$OUTPUT_DIR"/
          final_count=$(find "$OUTPUT_DIR" -name "*.ttf" | wc -l)
          echo "Generated $final_count final font files"
          
          if [ $final_count -eq 0 ]; then
            echo "❌ ERROR: No fonts were generated!"
            exit 1
          fi
        else
          echo "❌ ERROR: Output directory does not exist!"
          exit 1
        fi
        
        # Debug: Check what fonts were actually generated
        echo "Checking generated font names:"
        find "$OUTPUT_DIR" -name "*.ttf" -exec basename {} \;
        
    - name: Verify patched fonts
      run: |
        cd output/patched-fonts
        echo "Verifying font file integrity..."
        
        font_count=$(find . -name "*.ttf" | wc -l)
        echo "Generated font file count: $font_count"
        
        if [ $font_count -eq 0 ]; then
          echo "Error: No font files generated"
          echo "Checking for any output files:"
          ls -la .
          exit 1
        fi
        
        # Check each font file size
        for font in *.ttf; do
          if [ -f "$font" ]; then
            size=$(stat -c%s "$font")
            echo "$font: ${size} bytes"
            
            # Font files should be larger than 1MB (will be larger with icons)
            if [ $size -lt 1048576 ]; then
              echo "Warning: $font may be incomplete (less than 1MB)"
            fi
          fi
        done
        
    - name: Create release archive
      run: |
        cd output
        
        # Create font info file
        cat > patched-fonts/README.txt << 'EOL'
        Google Sans Code Nerd Font with Ligatures
        =========================================
        
        This package contains Google Sans Code Nerd Font versions with:
        - Programming ligatures (from Fira Code)
        - 3600+ programming-related icons and symbols
        
        Font features:
        - Complete ligature support for programming (==, !=, ->, =>, <=, >=, etc.)
        - All original Google Sans Code weights (Light, Regular, Medium, SemiBold, Bold, ExtraBold)
        - Italic variants included
        - Complete Nerd Font icon set added
        
        Installation:
        macOS (Homebrew):
          brew install font-google-sans-code-nerd
        
        Manual Installation:
        1. Extract all .ttf files
        2. Double-click font files to install to system
        3. Use font family name "Google Sans Code NF" in applications
        
        VS Code Configuration (with ligatures enabled):
        {
          "editor.fontFamily": "'Google Sans Code NF'",
          "editor.fontLigatures": true
        }
        
        Vim/Neovim Configuration:
        set guifont=Google\ Sans\ Code\ NF:h12
        
        More info: https://github.com/$GITHUB_REPOSITORY
        EOL
        
        echo "Build time: $(date)" >> patched-fonts/README.txt
        
        # Create release package
        zip -r "GoogleSansCodeNerdFont-$(date +%Y%m%d-%H%M).zip" patched-fonts/
        
        echo "Release package created:"
        ls -la *.zip
        
    - name: Upload google-sans-code-nerd-font
      uses: actions/upload-artifact@v4
      with:
        name: google-sans-code-nerd-font
        path: output/patched-fonts/
        retention-days: 90
