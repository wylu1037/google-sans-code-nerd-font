name: Build Google Sans Code Nerd Fonts

on:
  push:
    branches: [ main ]
    paths:
      - 'Google Sans Code/**'
      - 'scripts/**'
      - '.github/workflows/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'Google Sans Code/**'
      - 'scripts/**'
      - '.github/workflows/**'
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'æ„å»ºç±»å‹'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - complete
          - mono
          - propo
      upload_artifacts:
        description: 'ä¸Šä¼ æ„å»ºäº§ç‰©'
        required: false
        default: true
        type: boolean

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      build_types: ${{ steps.prepare_matrix.outputs.build_types }}
      platforms: ${{ steps.prepare_matrix.outputs.platforms }}
    steps:
    - name: Prepare build matrix
      id: prepare_matrix
      run: |
        if [ "${{ github.event.inputs.build_type }}" = "all" ] || [ -z "${{ github.event.inputs.build_type }}" ]; then
          echo 'build_types=["complete", "mono", "propo"]' >> $GITHUB_OUTPUT
        else
          echo 'build_types=["${{ github.event.inputs.build_type }}"]' >> $GITHUB_OUTPUT
        fi
        
        # For release events, build on all platforms; otherwise just Ubuntu
        if [ "${{ github.event_name }}" = "release" ]; then
          echo 'platforms=["ubuntu-latest", "windows-latest", "macos-latest"]' >> $GITHUB_OUTPUT
        else
          echo 'platforms=["ubuntu-latest"]' >> $GITHUB_OUTPUT
        fi

  build:
    runs-on: ${{ matrix.os }}
    needs: prepare
    strategy:
      matrix:
        os: ${{ fromJson(needs.prepare.outputs.platforms) }}
        build_type: ${{ fromJson(needs.prepare.outputs.build_types) }}
      fail-fast: false
    
    name: Build ${{ matrix.build_type }} on ${{ matrix.os }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        lfs: true
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install system dependencies (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y fontforge python3-fontforge
        pip install fonttools configparser
    
    - name: Install system dependencies (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        brew install fontforge
        pip install fonttools configparser
    
    - name: Install system dependencies (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        choco install fontforge -y
        pip install fonttools configparser
      shell: powershell
    
    - name: Cache Nerd Fonts dependencies
      uses: actions/cache@v4
      with:
        path: |
          src/
          !src/config.json
        key: nerd-fonts-v2-${{ runner.os }}-${{ hashFiles('scripts/setup.sh', 'scripts/setup.ps1') }}
        restore-keys: |
          nerd-fonts-v2-${{ runner.os }}-
          nerd-fonts-v2-
    
    - name: Cache Python packages
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: pip-${{ runner.os }}-${{ hashFiles('scripts/setup.sh', 'scripts/setup.ps1') }}
        restore-keys: |
          pip-${{ runner.os }}-
    
    - name: Setup build environment (Unix)
      if: matrix.os != 'windows-latest'
      run: |
        chmod +x scripts/setup.sh
        ./scripts/setup.sh
    
    - name: Setup build environment (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        .\scripts\setup.ps1
      shell: powershell
    
    - name: Verify font files and working directory
      run: |
        echo "=== å½“å‰å·¥ä½œç›®å½• ==="
        pwd
        echo ""
        echo "=== ç›®å½•ç»“æ„ ==="
        ls -la
        echo ""
        echo "=== éªŒè¯æºå­—ä½“æ–‡ä»¶ ==="
        if [ -d "Google Sans Code" ]; then
          find "Google Sans Code" -name "*.ttf" -o -name "*.otf" | sort
          echo ""
          echo "=== å­—ä½“æ–‡ä»¶ç»Ÿè®¡ ==="
          echo "TTF æ–‡ä»¶æ•°é‡: $(find "Google Sans Code" -name "*.ttf" | wc -l)"
          echo "OTF æ–‡ä»¶æ•°é‡: $(find "Google Sans Code" -name "*.otf" | wc -l)"
        else
          echo "ERROR: Google Sans Code ç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
    
    - name: Build fonts (${{ matrix.build_type }}) on Unix
      if: matrix.os != 'windows-latest'
      run: |
        chmod +x scripts/build.sh
        case "${{ matrix.build_type }}" in
          "complete")
            ./scripts/build.sh --complete --verbose
            ;;
          "mono")
            ./scripts/build.sh --mono --verbose
            ;;
          "propo")
            ./scripts/build.sh --propo --verbose
            ;;
          *)
            echo "æœªçŸ¥çš„æ„å»ºç±»å‹: ${{ matrix.build_type }}"
            exit 1
            ;;
        esac
    
    - name: Build fonts (${{ matrix.build_type }}) on Windows
      if: matrix.os == 'windows-latest'
      run: |
        switch ("${{ matrix.build_type }}") {
          "complete" { .\scripts\build.ps1 -Complete -Verbose }
          "mono" { .\scripts\build.ps1 -Mono -Verbose }
          "propo" { .\scripts\build.ps1 -Propo -Verbose }
          default { 
            Write-Error "æœªçŸ¥çš„æ„å»ºç±»å‹: ${{ matrix.build_type }}"
            exit 1
          }
        }
      shell: powershell
    
    - name: Verify build output (Unix)
      if: matrix.os != 'windows-latest'
      run: |
        echo "=== æ„å»ºè¾“å‡ºç»Ÿè®¡ ==="
        if [ -d "patched-fonts" ]; then
          echo "è¾“å‡ºå­—ä½“æ•°é‡: $(find patched-fonts -name "*.ttf" -o -name "*.otf" | wc -l)"
          echo ""
          echo "=== è¾“å‡ºæ–‡ä»¶åˆ—è¡¨ ==="
          find patched-fonts -name "*.ttf" -o -name "*.otf" | sort | head -20
          if [ $(find patched-fonts -name "*.ttf" -o -name "*.otf" | wc -l) -gt 20 ]; then
            echo "... è¿˜æœ‰æ›´å¤šæ–‡ä»¶"
          fi
          echo ""
          echo "=== ç›®å½•å¤§å° ==="
          du -sh patched-fonts
        else
          echo "é”™è¯¯: æœªæ‰¾åˆ°è¾“å‡ºç›®å½•"
          exit 1
        fi
    
    - name: Verify build output (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        Write-Host "=== æ„å»ºè¾“å‡ºç»Ÿè®¡ ==="
        if (Test-Path "patched-fonts") {
          $fontCount = (Get-ChildItem -Path "patched-fonts" -Include "*.ttf", "*.otf" -Recurse).Count
          Write-Host "è¾“å‡ºå­—ä½“æ•°é‡: $fontCount"
          Write-Host ""
          Write-Host "=== è¾“å‡ºæ–‡ä»¶åˆ—è¡¨ ==="
          Get-ChildItem -Path "patched-fonts" -Include "*.ttf", "*.otf" -Recurse | Select-Object -First 20 | ForEach-Object { Write-Host $_.Name }
          if ($fontCount -gt 20) {
            Write-Host "... è¿˜æœ‰æ›´å¤šæ–‡ä»¶"
          }
          Write-Host ""
          Write-Host "=== ç›®å½•å¤§å° ==="
          $size = (Get-ChildItem -Path "patched-fonts" -Recurse | Measure-Object -Property Length -Sum).Sum / 1MB
          Write-Host "${size:F2} MB"
        } else {
          Write-Error "é”™è¯¯: æœªæ‰¾åˆ°è¾“å‡ºç›®å½•"
          exit 1
        }
      shell: powershell
    
    - name: Prepare artifacts (Unix)
      if: (github.event.inputs.upload_artifacts == 'true' || github.event_name == 'release') && matrix.os != 'windows-latest'
      run: |
        # åˆ›å»ºå‘å¸ƒåŒ…
        cd patched-fonts
        
        # æŒ‰æ„å»ºç±»å‹ç»„ç»‡æ–‡ä»¶
        BUILD_TYPE="${{ matrix.build_type }}"
        
        # åˆ›å»ºå‹ç¼©åŒ…
        case "$BUILD_TYPE" in
          "complete")
            zip -r "../GoogleSansCodeNerdFont-Complete-${{ matrix.os }}.zip" . -x "*.DS_Store"
            ;;
          "mono")
            zip -r "../GoogleSansCodeNerdFont-Mono-${{ matrix.os }}.zip" . -x "*.DS_Store"
            ;;
          "propo")
            zip -r "../GoogleSansCodeNerdFont-Propo-${{ matrix.os }}.zip" . -x "*.DS_Store"
            ;;
        esac
        
        cd ..
        
        # éªŒè¯å‹ç¼©åŒ…
        echo "=== å‹ç¼©åŒ…ä¿¡æ¯ ==="
        ls -lh GoogleSansCodeNerdFont-*.zip 2>/dev/null || echo "æœªåˆ›å»ºå‹ç¼©åŒ…"
    
    - name: Prepare artifacts (Windows)
      if: (github.event.inputs.upload_artifacts == 'true' || github.event_name == 'release') && matrix.os == 'windows-latest'
      run: |
        # åˆ›å»ºå‘å¸ƒåŒ…
        Set-Location patched-fonts
        
        # æŒ‰æ„å»ºç±»å‹ç»„ç»‡æ–‡ä»¶
        $BUILD_TYPE = "${{ matrix.build_type }}"
        
        # åˆ›å»ºå‹ç¼©åŒ…
        switch ($BUILD_TYPE) {
          "complete" { 
            Compress-Archive -Path "." -DestinationPath "..\GoogleSansCodeNerdFont-Complete-${{ matrix.os }}.zip" -CompressionLevel Optimal
          }
          "mono" { 
            Compress-Archive -Path "." -DestinationPath "..\GoogleSansCodeNerdFont-Mono-${{ matrix.os }}.zip" -CompressionLevel Optimal
          }
          "propo" { 
            Compress-Archive -Path "." -DestinationPath "..\GoogleSansCodeNerdFont-Propo-${{ matrix.os }}.zip" -CompressionLevel Optimal
          }
        }
        
        Set-Location ..
        
        # éªŒè¯å‹ç¼©åŒ…
        Write-Host "=== å‹ç¼©åŒ…ä¿¡æ¯ ==="
        Get-ChildItem GoogleSansCodeNerdFont-*.zip -ErrorAction SilentlyContinue | ForEach-Object { 
          Write-Host "$($_.Name): $([math]::Round($_.Length / 1MB, 2)) MB"
        }
      shell: powershell
    
    - name: Upload artifacts
      if: github.event.inputs.upload_artifacts == 'true' || github.event_name == 'release'
      uses: actions/upload-artifact@v4
      with:
        name: GoogleSansCodeNerdFont-${{ matrix.build_type }}-${{ matrix.os }}
        path: |
          GoogleSansCodeNerdFont-*.zip
          patched-fonts/
        retention-days: 30

  release:
    if: github.event_name == 'release'
    needs: build
    runs-on: ubuntu-latest
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: Prepare release assets
      run: |
        mkdir -p release-assets
        
        # åˆå¹¶è·¨å¹³å°çš„ç›¸åŒæ„å»ºç±»å‹ï¼ˆä¿ç•™æœ€ä½³è´¨é‡ç‰ˆæœ¬ï¼‰
        for build_type in complete mono propo; do
          # ä¼˜å…ˆä½¿ç”¨ Ubuntu æ„å»ºçš„ç‰ˆæœ¬ï¼ˆå…¼å®¹æ€§æœ€å¥½ï¼‰
          if [ -f "artifacts/GoogleSansCodeNerdFont-${build_type}-ubuntu-latest/GoogleSansCodeNerdFont-${build_type^}-ubuntu-latest.zip" ]; then
            cp "artifacts/GoogleSansCodeNerdFont-${build_type}-ubuntu-latest/GoogleSansCodeNerdFont-${build_type^}-ubuntu-latest.zip" "release-assets/GoogleSansCodeNerdFont-${build_type^}.zip"
          # å¤‡é€‰å…¶ä»–å¹³å°
          elif [ -f "artifacts/GoogleSansCodeNerdFont-${build_type}-macos-latest/GoogleSansCodeNerdFont-${build_type^}-macos-latest.zip" ]; then
            cp "artifacts/GoogleSansCodeNerdFont-${build_type}-macos-latest/GoogleSansCodeNerdFont-${build_type^}-macos-latest.zip" "release-assets/GoogleSansCodeNerdFont-${build_type^}.zip"
          elif [ -f "artifacts/GoogleSansCodeNerdFont-${build_type}-windows-latest/GoogleSansCodeNerdFont-${build_type^}-windows-latest.zip" ]; then
            cp "artifacts/GoogleSansCodeNerdFont-${build_type}-windows-latest/GoogleSansCodeNerdFont-${build_type^}-windows-latest.zip" "release-assets/GoogleSansCodeNerdFont-${build_type^}.zip"
          fi
        done
        
        # ç”Ÿæˆæ ¡éªŒå’Œæ–‡ä»¶
        cd release-assets
        sha256sum *.zip > checksums.sha256
        cd ..
        
        echo "=== å‘å¸ƒèµ„äº§ ==="
        ls -lh release-assets/
        echo ""
        echo "=== æ ¡éªŒå’Œ ==="
        cat release-assets/checksums.sha256
    
    - name: Upload release assets
      uses: softprops/action-gh-release@v1
      with:
        files: release-assets/*
        tag_name: ${{ github.ref_name }}
        name: Google Sans Code Nerd Font ${{ github.ref_name }}
        body: |
          ## Google Sans Code Nerd Font ${{ github.ref_name }}
          
          ### ğŸ“¦ ä¸‹è½½è¯´æ˜
          
          - **GoogleSansCodeNerdFont-Complete.zip** - å®Œæ•´ç‰ˆæœ¬ï¼ŒåŒ…å«æ‰€æœ‰å›¾æ ‡ï¼ˆæ¨èï¼‰
          - **GoogleSansCodeNerdFont-Mono.zip** - ç­‰å®½å›¾æ ‡ç‰ˆæœ¬ï¼Œé€‚åˆç»ˆç«¯ä½¿ç”¨
          - **GoogleSansCodeNerdFont-Propo.zip** - æ¯”ä¾‹å®½åº¦å›¾æ ‡ç‰ˆæœ¬
          - **checksums.sha256** - æ–‡ä»¶å®Œæ•´æ€§æ ¡éªŒå’Œ
          
          ### ğŸ” æ–‡ä»¶éªŒè¯
          
          ä¸‹è½½åè¯·éªŒè¯æ–‡ä»¶å®Œæ•´æ€§ï¼š
          ```bash
          # Linux/macOS
          sha256sum -c checksums.sha256
          
          # Windows PowerShell
          Get-FileHash *.zip -Algorithm SHA256 | Format-Table
          ```
          
          ### ğŸ¯ åŒ…å«çš„å›¾æ ‡é›†
          
          - Font Awesome (5000+ å›¾æ ‡)
          - Material Design Icons (7000+ å›¾æ ‡)
          - Octicons (GitHub å›¾æ ‡)
          - Powerline Symbols
          - Devicons (å¼€å‘è€…å›¾æ ‡)
          - Weather Icons
          - Codicons (VS Code å›¾æ ‡)
          - ä»¥åŠæ›´å¤š...
          
          ### ğŸ’¾ å®‰è£…æ–¹æ³•
          
          #### Windows
          1. ä¸‹è½½å¯¹åº”çš„ zip æ–‡ä»¶
          2. è§£å‹ç¼©
          3. å³é”®å­—ä½“æ–‡ä»¶é€‰æ‹©"å®‰è£…"æˆ–"ä¸ºæ‰€æœ‰ç”¨æˆ·å®‰è£…"
          4. åœ¨åº”ç”¨ç¨‹åºä¸­é€‰æ‹© "GoogleSansCodeNerdFont" å­—ä½“
          
          #### macOS
          1. ä¸‹è½½å¯¹åº”çš„ zip æ–‡ä»¶
          2. è§£å‹ç¼©
          3. åŒå‡»å­—ä½“æ–‡ä»¶å¹¶ç‚¹å‡»"å®‰è£…å­—ä½“"
          4. åœ¨åº”ç”¨ç¨‹åºä¸­é€‰æ‹© "GoogleSansCodeNerdFont" å­—ä½“
          
          #### Linux
          ```bash
          # ç”¨æˆ·å®‰è£…
          mkdir -p ~/.local/share/fonts
          unzip GoogleSansCodeNerdFont-Complete.zip -d ~/.local/share/fonts/
          fc-cache -fv
          
          # ç³»ç»Ÿçº§å®‰è£… (éœ€è¦ sudo)
          sudo unzip GoogleSansCodeNerdFont-Complete.zip -d /usr/share/fonts/
          sudo fc-cache -fv
          ```
          
          ### ğŸ”§ æ”¯æŒçš„å­—é‡
          
          - Regular / Italic
          - Light / Light Italic
          - Medium / Medium Italic
          - SemiBold / SemiBold Italic
          - Bold / Bold Italic
          - ExtraBold / ExtraBold Italic
          
          ---
          
          **æ„å»ºä¿¡æ¯**
          - æ„å»ºæ—¶é—´: ${{ github.run_id }}
          - Git æäº¤: ${{ github.sha }}
          - å‘å¸ƒç‰ˆæœ¬: ${{ github.ref_name }}
          
          ğŸ¤– è‡ªåŠ¨æ„å»ºäº GitHub Actions
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

