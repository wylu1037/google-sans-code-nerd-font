name: Build Google Sans Code Nerd Fonts

on:
  push:
    branches: [ main ]
    paths:
      - 'Google Sans Code/**'
      - 'scripts/**'
      - '.github/workflows/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'Google Sans Code/**'
      - 'scripts/**'
      - '.github/workflows/**'
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'æ„å»ºç±»å‹'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - complete
          - mono
          - propo
      upload_artifacts:
        description: 'ä¸Šä¼ æ„å»ºäº§ç‰©'
        required: false
        default: true
        type: boolean

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        build_type: 
          - ${{ github.event.inputs.build_type == 'all' && 'complete' || github.event.inputs.build_type || 'complete' }}
          - ${{ github.event.inputs.build_type == 'all' && 'mono' || '' }}
          - ${{ github.event.inputs.build_type == 'all' && 'propo' || '' }}
      fail-fast: false
    
    name: Build (${{ matrix.build_type }})
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        lfs: true
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y fontforge python3-fontforge
        pip install fonttools configparser
    
    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          src/
          !src/config.json
        key: nerd-font-deps-${{ hashFiles('scripts/setup.sh') }}
        restore-keys: |
          nerd-font-deps-
    
    - name: Setup build environment
      run: |
        chmod +x scripts/setup.sh
        ./scripts/setup.sh
    
    - name: Verify font files
      run: |
        echo "=== éªŒè¯æºå­—ä½“æ–‡ä»¶ ==="
        find "Google Sans Code" -name "*.ttf" -o -name "*.otf" | sort
        echo ""
        echo "=== å­—ä½“æ–‡ä»¶ç»Ÿè®¡ ==="
        echo "TTF æ–‡ä»¶æ•°é‡: $(find "Google Sans Code" -name "*.ttf" | wc -l)"
        echo "OTF æ–‡ä»¶æ•°é‡: $(find "Google Sans Code" -name "*.otf" | wc -l)"
    
    - name: Build fonts (${{ matrix.build_type }})
      if: matrix.build_type != ''
      run: |
        chmod +x scripts/build.sh
        case "${{ matrix.build_type }}" in
          "complete")
            ./scripts/build.sh --complete --verbose
            ;;
          "mono")
            ./scripts/build.sh --mono --verbose
            ;;
          "propo")
            ./scripts/build.sh --propo --verbose
            ;;
          *)
            echo "æœªçŸ¥çš„æ„å»ºç±»å‹: ${{ matrix.build_type }}"
            exit 1
            ;;
        esac
    
    - name: Verify build output
      if: matrix.build_type != ''
      run: |
        echo "=== æ„å»ºè¾“å‡ºç»Ÿè®¡ ==="
        if [ -d "patched-fonts" ]; then
          echo "è¾“å‡ºå­—ä½“æ•°é‡: $(find patched-fonts -name "*.ttf" -o -name "*.otf" | wc -l)"
          echo ""
          echo "=== è¾“å‡ºæ–‡ä»¶åˆ—è¡¨ ==="
          find patched-fonts -name "*.ttf" -o -name "*.otf" | sort | head -20
          if [ $(find patched-fonts -name "*.ttf" -o -name "*.otf" | wc -l) -gt 20 ]; then
            echo "... è¿˜æœ‰æ›´å¤šæ–‡ä»¶"
          fi
          echo ""
          echo "=== ç›®å½•å¤§å° ==="
          du -sh patched-fonts
        else
          echo "é”™è¯¯: æœªæ‰¾åˆ°è¾“å‡ºç›®å½•"
          exit 1
        fi
    
    - name: Prepare artifacts
      if: matrix.build_type != '' && (github.event.inputs.upload_artifacts == 'true' || github.event_name == 'release')
      run: |
        # åˆ›å»ºå‘å¸ƒåŒ…
        cd patched-fonts
        
        # æŒ‰æ„å»ºç±»å‹ç»„ç»‡æ–‡ä»¶
        BUILD_TYPE="${{ matrix.build_type }}"
        
        # åˆ›å»ºå‹ç¼©åŒ…
        case "$BUILD_TYPE" in
          "complete")
            zip -r "../GoogleSansCodeNerdFont-Complete.zip" . -x "*.DS_Store"
            ;;
          "mono")
            zip -r "../GoogleSansCodeNerdFont-Mono.zip" . -x "*.DS_Store"
            ;;
          "propo")
            zip -r "../GoogleSansCodeNerdFont-Propo.zip" . -x "*.DS_Store"
            ;;
        esac
        
        cd ..
        
        # éªŒè¯å‹ç¼©åŒ…
        echo "=== å‹ç¼©åŒ…ä¿¡æ¯ ==="
        ls -lh GoogleSansCodeNerdFont-*.zip 2>/dev/null || echo "æœªåˆ›å»ºå‹ç¼©åŒ…"
    
    - name: Upload artifacts
      if: matrix.build_type != '' && (github.event.inputs.upload_artifacts == 'true' || github.event_name == 'release')
      uses: actions/upload-artifact@v4
      with:
        name: GoogleSansCodeNerdFont-${{ matrix.build_type }}
        path: |
          GoogleSansCodeNerdFont-*.zip
          patched-fonts/
        retention-days: 30

  release:
    if: github.event_name == 'release'
    needs: build
    runs-on: ubuntu-latest
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: Prepare release assets
      run: |
        mkdir -p release-assets
        
        # ç§»åŠ¨æ‰€æœ‰ zip æ–‡ä»¶åˆ° release-assets
        find artifacts -name "*.zip" -exec mv {} release-assets/ \;
        
        echo "=== å‘å¸ƒèµ„äº§ ==="
        ls -lh release-assets/
    
    - name: Upload release assets
      uses: softprops/action-gh-release@v1
      with:
        files: release-assets/*
        tag_name: ${{ github.ref_name }}
        name: Google Sans Code Nerd Font ${{ github.ref_name }}
        body: |
          ## Google Sans Code Nerd Font ${{ github.ref_name }}
          
          ### ğŸ“¦ ä¸‹è½½è¯´æ˜
          
          - **Complete**: åŒ…å«æ‰€æœ‰å›¾æ ‡çš„å®Œæ•´ç‰ˆæœ¬ï¼ˆæ¨èï¼‰
          - **Mono**: ç­‰å®½å›¾æ ‡ç‰ˆæœ¬ï¼Œé€‚åˆç»ˆç«¯ä½¿ç”¨
          - **Propo**: æ¯”ä¾‹å®½åº¦å›¾æ ‡ç‰ˆæœ¬
          
          ### ğŸ¯ åŒ…å«çš„å›¾æ ‡é›†
          
          - Font Awesome (5000+ å›¾æ ‡)
          - Material Design Icons (7000+ å›¾æ ‡)
          - Octicons (GitHub å›¾æ ‡)
          - Powerline Symbols
          - Devicons (å¼€å‘è€…å›¾æ ‡)
          - Weather Icons
          - Codicons (VS Code å›¾æ ‡)
          - ä»¥åŠæ›´å¤š...
          
          ### ğŸ’¾ å®‰è£…æ–¹æ³•
          
          1. ä¸‹è½½å¯¹åº”çš„ zip æ–‡ä»¶
          2. è§£å‹åå®‰è£…å­—ä½“æ–‡ä»¶
          3. åœ¨æ‚¨çš„ç»ˆç«¯æˆ–ç¼–è¾‘å™¨ä¸­é€‰æ‹© "GoogleSansCodeNerdFont" å­—ä½“ç³»åˆ—
          
          ### ğŸ”§ æ”¯æŒçš„å­—é‡
          
          - Regular / Italic
          - Light / Light Italic
          - Medium / Medium Italic
          - SemiBold / SemiBold Italic
          - Bold / Bold Italic
          - ExtraBold / ExtraBold Italic
          
          ---
          
          æ„å»ºæ—¶é—´: ${{ github.run_id }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
      fail-fast: false
    
    name: Test setup on ${{ matrix.os }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install system dependencies (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y fontforge python3-fontforge
    
    - name: Install system dependencies (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        brew install fontforge
    
    - name: Install system dependencies (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        # ä½¿ç”¨ Chocolatey å®‰è£… FontForge
        choco install fontforge -y
      shell: powershell
    
    - name: Install Python dependencies
      run: |
        pip install fonttools configparser
    
    - name: Test setup script (Unix)
      if: matrix.os != 'windows-latest'
      run: |
        chmod +x scripts/setup.sh
        # åªéªŒè¯è„šæœ¬è¯­æ³•ï¼Œä¸å®é™…ä¸‹è½½
        bash -n scripts/setup.sh
        chmod +x scripts/build.sh
        bash -n scripts/build.sh
    
    - name: Test setup script (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        # éªŒè¯ PowerShell è„šæœ¬è¯­æ³•
        Get-Command .\scripts\setup.ps1
        Get-Command .\scripts\build.ps1
      shell: powershell
    
    - name: Verify dependencies
      run: |
        python --version
        pip list | grep fonttools || echo "fonttools not found"
      shell: bash